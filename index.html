<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pig Love Poop - å®‰å…¨æ¨¡å¼</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            margin: 0; overflow: hidden; background-color: #000;
            font-family: 'Fredoka One', cursive, sans-serif;
            touch-action: none; user-select: none;
        }

        #game-container {
            position: relative; width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: #000; overflow: hidden;
        }

        canvas { width: 100%; height: 100%; object-fit: contain; }

        /* UI */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
        }
        .header { display: flex; justify-content: space-between; width: 100%; }
        .score-box {
            background: rgba(255,255,255,0.9); border: 4px solid #ff9ff3; border-radius: 15px;
            padding: 10px 20px; text-align: center; min-width: 100px;
        }
        .score-val { font-size: 32px; color: #333; line-height: 1; }
        .level-val { font-size: 14px; color: #666; }
        
        .xp-bar {
            width: 100%; height: 10px; background: rgba(0,0,0,0.5);
            position: absolute; bottom: 0; left: 0;
        }
        .xp-fill { height: 100%; width: 0%; background: #f1c40f; transition: width 0.2s; }

        /* å¯åŠ¨é¡µ */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, #1a1a1a 0%, #000000 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 0.5s;
        }
        h1 { color: white; font-size: 4rem; text-align: center; margin-bottom: 20px; text-shadow: 0 0 10px #ff9ff3; }
        .btn-start {
            background: transparent; color: white; border: 2px solid white;
            padding: 15px 60px; font-size: 1.5rem; border-radius: 50px; cursor: pointer;
        }
        .btn-start:hover { background: white; color: black; }

        /* è°ƒè¯•ä¿¡æ¯ (å¦‚æœæœ‰é—®é¢˜èƒ½çœ‹åˆ°) */
        #debug-info {
            position: absolute; top: 60px; left: 20px; color: #0f0; font-size: 12px;
            font-family: monospace; background: rgba(0,0,0,0.7); padding: 5px;
            pointer-events: none; z-index: 20; max-width: 300px;
        }

        #toast {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: #ff9ff3; padding: 15px 30px; border-radius: 30px;
            color: white; font-size: 24px; border: 4px solid #fff;
            opacity: 0; transition: all 0.4s; z-index: 20; text-align: center;
        }
        #toast.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="debug-info">Debug Mode Active</div>

    <div class="ui-layer" id="uiLayer" style="opacity:0">
        <div class="header">
            <div class="score-box">
                <div class="score-val" id="scoreVal">0</div>
                <div class="level-val" id="levelVal">Lv.1</div>
            </div>
            <!-- éŸ³ä¹æŒ‰é’® -->
            <div style="pointer-events:auto; background:rgba(0,0,0,0.5); color:white; width:40px; height:40px; border-radius:50%; display:flex; justify-content:center; align-items:center; cursor:pointer;" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
        </div>
        <div class="xp-bar">
            <div class="xp-fill" id="xpFill"></div>
        </div>
    </div>

    <div id="toast">LEVEL UP!</div>

    <div id="start-screen">
        <h1>PIG LOVE POOP</h1>
        <button class="btn-start" onclick="startGame()">START GAME</button>
        <div style="color:#666; margin-top:10px; font-size:12px">v3.0 Safe Mode</div>
    </div>
</div>

<script>
    // ================= é…ç½® =================
    const PATHS = {
        pig:       "assets/pig.png",
        poop:      "assets/poop.png",
        bg_farm:   "assets/bg_farm.png",
        bg_road:   "assets/bg_road.png",
        bg_bikini: "assets/bg_bikini.png",
        bg_cotton: "assets/bg_cotton.png",
        bg_moon:   "assets/bg_moon.png",
        music_1:   "assets/music_1.mp3",
        music_2:   "assets/music_2.mp3"
    };

    // èµ„æºåŠ è½½å™¨
    const IMAGES = {};
    const AUDIO = { bgm1: null, bgm2: null, current: null, isMuted: false };
    const debugEl = document.getElementById('debug-info');

    function log(msg) {
        debugEl.innerHTML += msg + "<br>";
        console.log(msg);
    }

    function loadImage(key, src) {
        const img = new Image();
        img.src = src;
        img.onload = () => log(`âœ… Loaded: ${key}`);
        img.onerror = () => log(`âŒ Failed: ${key} (${src})`);
        return img;
    }

    // åˆå§‹åŒ–
    function initAssets() {
        log("--- å¼€å§‹åŠ è½½èµ„æº ---");
        IMAGES.pig = loadImage('pig', PATHS.pig);
        IMAGES.poop = loadImage('poop', PATHS.poop);
        ['farm','road','bikini','cotton','moon'].forEach(k => {
            IMAGES[k] = loadImage(k, PATHS['bg_'+k]);
        });

        // éŸ³é¢‘
        AUDIO.bgm1 = new Audio(PATHS.music_1); AUDIO.bgm1.loop = true;
        AUDIO.bgm2 = new Audio(PATHS.music_2); AUDIO.bgm2.loop = true;
    }
    initAssets();

    // ================= æ¸¸æˆé€»è¾‘ =================
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const G_W = 1920, G_H = 1080;

    let state = {
        active: false,
        score: 0, level: 1, xp: 0, maxXp: 10,
        rainMode: false, rainTimer: 0,
        pig: { x: G_W/2, y: G_H/2, vx:0, vy:0, faceLeft:false, buffs:{} },
        poops: [], particles: [],
        keys: { w:false, a:false, s:false, d:false },
        mouse: { x:null, y:null, active:false }
    };

    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    // è¾“å…¥
    window.addEventListener('keydown', e => state.keys[e.key.toLowerCase()] = true);
    window.addEventListener('keyup', e => state.keys[e.key.toLowerCase()] = false);
    canvas.addEventListener('pointerdown', e => { state.mouse.active=true; updateMouse(e); });
    canvas.addEventListener('pointermove', e => { if(state.mouse.active) updateMouse(e); });
    canvas.addEventListener('pointerup', () => state.mouse.active=false);

    function updateMouse(e) {
        let s = Math.min(canvas.width/G_W, canvas.height/G_H);
        let dx = (canvas.width - G_W*s)/2;
        let dy = (canvas.height - G_H*s)/2;
        state.mouse.x = (e.clientX - dx)/s;
        state.mouse.y = (e.clientY - dy)/s;
    }

    function playMusic(id) {
        if(AUDIO.isMuted) return;
        let target = id===1 ? AUDIO.bgm1 : AUDIO.bgm2;
        let other = id===1 ? AUDIO.bgm2 : AUDIO.bgm1;
        
        if(AUDIO.current !== target) {
            other.pause(); other.currentTime = 0;
            target.play().catch(e => log("ğŸµ ç‚¹å‡»å±å¹•æ’­æ”¾éŸ³ä¹"));
            AUDIO.current = target;
        }
    }

    function toggleMute() {
        AUDIO.isMuted = !AUDIO.isMuted;
        document.getElementById('muteBtn').innerText = AUDIO.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
        if(AUDIO.isMuted && AUDIO.current) AUDIO.current.pause();
        else if(AUDIO.current) AUDIO.current.play();
    }

    function startGame() {
        state.active = true;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('uiLayer').style.opacity = 1;
        playMusic(1);
        loop();
        spawner();
        log("ğŸš€ æ¸¸æˆå¼€å§‹!");
    }

    function loop() {
        if(!state.active) return;
        update();
        draw();
        requestAnimationFrame(loop);
    }

    function update() {
        const scene = getScene();
        
        // çŒªç§»åŠ¨
        let speed = 12 + (state.level*0.5);
        if(scene === 'moon') speed = 25;
        if(state.pig.buffs.speed > 0) { speed *= 2; state.pig.buffs.speed--; }

        let ax=0, ay=0;
        if(state.keys.w) ay = -1; if(state.keys.s) ay = 1;
        if(state.keys.a) ax = -1; if(state.keys.d) ax = 1;
        if(state.mouse.active) {
            let ang = Math.atan2(state.mouse.y - state.pig.y, state.mouse.x - state.pig.x);
            ax = Math.cos(ang); ay = Math.sin(ang);
        }

        state.pig.vx += ax * 1.5; state.pig.vy += ay * 1.5;
        state.pig.vx *= 0.9; state.pig.vy *= 0.9;
        
        let v = Math.hypot(state.pig.vx, state.pig.vy);
        if(v > speed) { state.pig.vx = (state.pig.vx/v)*speed; state.pig.vy = (state.pig.vy/v)*speed; }

        state.pig.x += state.pig.vx; state.pig.y += state.pig.vy;
        // è¾¹ç•Œ
        if(state.pig.x<50) state.pig.x=50; if(state.pig.x>G_W-50) state.pig.x=G_W-50;
        if(state.pig.y<50) state.pig.y=50; if(state.pig.y>G_H-50) state.pig.y=G_H-50;
        
        if(state.pig.vx < -0.5) state.pig.faceLeft = false;
        if(state.pig.vx > 0.5) state.pig.faceLeft = true;

        // å±é€»è¾‘
        if(state.rainMode) { state.rainTimer--; if(state.rainTimer<=0) state.rainMode=false; }

        for(let i=state.poops.length-1; i>=0; i--) {
            let p = state.poops[i];
            if(p.scale < 1) p.scale += 0.05;
            
            // å¸é™„
            if(state.level >= 5 && p.type !== 'stinky' && p.type !== 'sticky') {
                let d = Math.hypot(p.x - state.pig.x, p.y - state.pig.y);
                if(d < 350) {
                    p.x += (state.pig.x - p.x)*0.1; p.y += (state.pig.y - p.y)*0.1;
                }
            }

            let hitR = 80 + state.level;
            if(Math.hypot(p.x - state.pig.x, p.y - state.pig.y) < hitR) eat(p, i);
        }
    }

    function eat(p, idx) {
        state.poops.splice(idx, 1);
        let val=1;
        if(p.type === 'speed') { state.pig.buffs.speed = 300; showMsg("âš¡ åŠ é€Ÿ!"); }
        if(p.type === 'boom') { 
            state.poops.forEach(o => {
                if(Math.hypot(o.x-state.pig.x, o.y-state.pig.y) < 600) { o.x=state.pig.x; o.y=state.pig.y; }
            });
            showMsg("ğŸ’¥ ç‚¸è£‚!");
        }

        state.xp += val; state.score += 10;
        if(state.xp >= state.maxXp) {
            state.level++; state.xp = 0; state.maxXp = Math.floor(state.maxXp*1.2);
            if(state.level===21) playMusic(2);
            showMsg("LEVEL UP!");
        }
        document.getElementById('scoreVal').innerText = state.score;
        document.getElementById('levelVal').innerText = `Lv.${state.level} ${getScene()}`;
        document.getElementById('xpFill').style.width = `${(state.xp/state.maxXp)*100}%`;
    }

    function spawner() {
        if(!state.active) return;
        let delay = 800;
        if(state.rainMode) delay = 60;
        setTimeout(() => { spawn(); spawner(); }, delay);
    }

    function spawn() {
        if(state.poops.length > 50) return;
        if(!state.rainMode && Math.random()<0.008) { state.rainMode=true; state.rainTimer=400; showMsg("ğŸ’© æš´é›¨æ¥è¢­!"); }
        
        let type='normal';
        let r = Math.random();
        if(r<0.05) type='speed'; else if(r<0.1) type='boom';

        state.poops.push({
            x: Math.random()*(G_W-100)+50, y: Math.random()*(G_H-100)+50,
            type: type, scale: 0, float: Math.random()*100
        });
    }

    function getScene() {
        if(state.level <= 5) return 'farm';
        if(state.level <= 10) return 'road';
        if(state.level <= 15) return 'bikini';
        if(state.level <= 20) return 'cotton';
        return 'moon';
    }

    function showMsg(t) {
        const toast = document.getElementById('toast');
        toast.innerText = t;
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 1500);
    }

    /* ================= ç»å¯¹å®‰å…¨çš„æ¸²æŸ“å‡½æ•° ================= */
    function draw() {
        let s = Math.min(canvas.width/G_W, canvas.height/G_H);
        let dx = (canvas.width - G_W*s)/2;
        let dy = (canvas.height - G_H*s)/2;

        // æ¸…ç©º
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);

        ctx.save();
        ctx.translate(dx, dy); ctx.scale(s, s);
        ctx.beginPath(); ctx.rect(0,0,G_W,G_H); ctx.clip();

        const scene = getScene();
        
        // 1. ç»˜åˆ¶èƒŒæ™¯ (å®‰å…¨æ¨¡å¼)
        let bgImg = IMAGES.bg[scene];
        if(bgImg && bgImg.complete && bgImg.naturalWidth !== 0) {
            ctx.drawImage(bgImg, 0, 0, G_W, G_H);
        } else {
            // âš ï¸ å›¾ç‰‡æ²¡åŠ è½½å‡ºæ¥æ—¶çš„å…œåº•é¢œè‰²
            if(scene==='farm') ctx.fillStyle = "#78e08f";
            else if(scene==='road') ctx.fillStyle = "#636e72";
            else if(scene==='bikini') ctx.fillStyle = "#0984e3";
            else if(scene==='cotton') ctx.fillStyle = "#ff9ff3";
            else ctx.fillStyle = "#2f3640";
            ctx.fillRect(0,0,G_W,G_H);
            // ç”»ç½‘æ ¼è¡¨ç¤ºåœ°é¢
            ctx.strokeStyle = "rgba(255,255,255,0.1)";
            ctx.lineWidth = 5;
            ctx.beginPath();
            for(let i=0;i<G_W;i+=200) { ctx.moveTo(i,0); ctx.lineTo(i,G_H); }
            for(let i=0;i<G_H;i+=200) { ctx.moveTo(0,i); ctx.lineTo(G_W,i); }
            ctx.stroke();
        }

        // 2. ç»˜åˆ¶ç‰©å“ (å±)
        state.poops.forEach(p => {
            let hover = Math.sin((Date.now()/200)+p.float) * 5;
            ctx.save();
            ctx.translate(p.x, p.y + hover);
            ctx.scale(p.scale, p.scale);

            // å¦‚æœæœ‰å›¾ç”»å›¾ï¼Œæ²¡å›¾ç”»åœ†
            if(IMAGES.poop && IMAGES.poop.complete && IMAGES.poop.naturalWidth !== 0) {
                ctx.drawImage(IMAGES.poop, -40, -40, 80, 80);
            } else {
                // âš ï¸ å…œåº•ï¼šç”»ä¸€ä¸ªæ£•è‰²çš„åœ†
                ctx.fillStyle = (p.type==='speed'?'blue':(p.type==='boom'?'red':'#8B5E3C'));
                ctx.beginPath(); ctx.arc(0,0,40,0,Math.PI*2); ctx.fill();
                ctx.fillStyle = "white"; ctx.font = "20px Arial"; ctx.fillText("ğŸ’©", -12, 8);
            }
            ctx.restore();
        });

        // 3. ç»˜åˆ¶çŒª
        ctx.save();
        ctx.translate(state.pig.x, state.pig.y);
        let pScale = 1 + (state.level * 0.05);
        if(state.pig.faceLeft) ctx.scale(-pScale, pScale); else ctx.scale(pScale, pScale);

        // å¦‚æœæœ‰å›¾ç”»å›¾ï¼Œæ²¡å›¾ç”»æ–¹å—
        if(IMAGES.pig && IMAGES.pig.complete && IMAGES.pig.naturalWidth !== 0) {
            ctx.drawImage(IMAGES.pig, -75, -60, 150, 120);
        } else {
            // âš ï¸ å…œåº•ï¼šç”»ä¸€ä¸ªç²‰è‰²æ–¹å—
            ctx.fillStyle = "pink";
            ctx.fillRect(-60, -50, 120, 100);
            ctx.fillStyle = "black";
            ctx.font = "20px Arial"; ctx.fillText("ğŸ·", -12, 8);
        }
        
        // è¿›åŒ–é…ä»¶ (Canvasç»˜åˆ¶)
        if(state.level >= 10) { 
            ctx.fillStyle = "black"; ctx.fillRect(-45, -12, 20, 10); ctx.fillRect(-20, -12, 20, 10);
            ctx.beginPath(); ctx.moveTo(-25,-7); ctx.lineTo(-20,-7); ctx.stroke();
        }
        if(state.level >= 15) { 
            ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.moveTo(10,-20); ctx.lineTo(60,20); ctx.lineTo(60,60); ctx.lineTo(10,40); ctx.fill();
        }

        ctx.restore();
        ctx.restore();
    }

</script>
</body>
</html>
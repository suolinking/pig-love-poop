<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pig Love Poop</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Fredoka One', cursive, sans-serif;
            touch-action: none;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; padding: 20px; box-sizing: border-box;
            display: flex; flex-direction: column; justify-content: space-between; z-index: 10;
            transition: opacity 0.5s;
        }

        .header { display: flex; justify-content: space-between; width: 100%; align-items: flex-start; }

        .score-box {
            background: rgba(255,255,255,0.9); border: 4px solid #ff9ff3; border-radius: 15px;
            padding: 10px 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .score-val { font-size: 32px; color: #2d3436; line-height: 1; }
        .level-val { font-size: 14px; color: #666; }

        .mute-btn {
            pointer-events: auto; background: rgba(0,0,0,0.6); border: 2px solid rgba(255,255,255,0.5);
            color: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 20px; cursor: pointer;
        }

        .xp-bar-container {
            width: 100%; height: 12px; background: rgba(0,0,0,0.5);
            position: absolute; bottom: 0; left: 0; border-top: 2px solid rgba(255,255,255,0.3);
        }
        .xp-fill {
            height: 100%; width: 0%; background: linear-gradient(90deg, #f1c40f, #e67e22); transition: width 0.2s;
        }

        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; transition: opacity 0.5s, transform 0.5s;
        }
        #start-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }

        .stars-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: radial-gradient(2px 2px at 20px 30px, #eee, rgba(0,0,0,0)), radial-gradient(2px 2px at 40px 70px, #fff, rgba(0,0,0,0));
            background-repeat: repeat; background-size: 200px 200px; opacity: 0.6;
        }

        h1 {
            font-size: 5rem; color: white; margin: 0; text-shadow: 0 0 20px #ff9ff3;
            font-weight: 400; letter-spacing: 3px; z-index: 2; text-align: center;
        }

        .btn-start {
            margin-top: 50px; background: transparent; color: white; border: 2px solid white;
            padding: 15px 60px; font-size: 1.5rem; font-family: inherit; cursor: pointer;
            transition: 0.3s; z-index: 2; border-radius: 50px;
        }
        .btn-start:hover { background: white; color: black; box-shadow: 0 0 20px white; }
        .btn-start:disabled { opacity: 0.5; cursor: not-allowed; }

        #loading-text { margin-top: 20px; color: #888; font-size: 14px; }

        #fx-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; mix-blend-mode: overlay; transition: background 0.1s; z-index: 5;
        }
        .flash { background-color: rgba(255,255,255,0.8) !important; }
        .dizzy { backdrop-filter: blur(4px) hue-rotate(90deg); }

        #toast {
            position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #ff9ff3, #feca57); padding: 15px 30px; border-radius: 30px;
            color: white; font-size: 24px; border: 4px solid #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; transition: all 0.4s; z-index: 20;
            text-align: center; white-space: nowrap;
        }
        #toast.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="fx-layer"></div>

        <div class="ui-layer" id="uiLayer" style="opacity:0">
            <div class="header">
                <div class="score-box">
                    <div class="score-val" id="scoreVal">0</div>
                    <div class="level-val" id="levelVal">Lv.1 å†œåœº</div>
                </div>
                <div class="mute-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
            </div>
            <div class="xp-bar-container">
                <div class="xp-fill" id="xpFill"></div>
            </div>
        </div>

        <div id="toast">LEVEL UP!</div>

        <div id="start-screen">
            <div class="stars-bg"></div>
            <h1>pig love poop</h1>
            <button class="btn-start" id="startBtn" onclick="startGame()" disabled>Loading...</button>
            <div id="loading-text">èµ„æºåŠ è½½ä¸­...</div>
        </div>
    </div>

    <script>
        /* ================= é…ç½®åŒº ================= */
        
        // ä½ çš„æ–‡ä»¶è·¯å¾„ (è¯·ç¡®ä¿ assets æ–‡ä»¶å¤¹å’Œæ–‡ä»¶éƒ½å­˜åœ¨)
        const PATHS = {
            pig:       "assets/pig.png",
            poop:      "assets/poop.png",
            bg_farm:   "assets/bg_farm.png",
            bg_road:   "assets/bg_road.png",
            bg_bikini: "assets/bg_bikini.png",
            bg_cotton: "assets/bg_cotton.png",
            bg_moon:   "assets/bg_moon.png",
            music_1:   "assets/music_1.mp3",
            music_2:   "assets/music_2.mp3"
        };

        // å†…ç½®å¤‡ä»½ SVG (å¦‚æœä½ çš„pngåŠ è½½å¤±è´¥ï¼Œä¼šè‡ªåŠ¨ç”¨è¿™ä¸ªï¼Œé˜²æ­¢éšå½¢)
        const BACKUP_SVG = {
            pig: `data:image/svg+xml;utf8,${encodeURIComponent('<svg width="100" height="80" xmlns="http://www.w3.org/2000/svg"><ellipse cx="50" cy="40" rx="40" ry="30" fill="pink"/><circle cx="35" cy="35" r="5" fill="black"/><circle cx="65" cy="35" r="5" fill="black"/><ellipse cx="50" cy="50" rx="10" ry="8" fill="#ff6b6b"/></svg>')}`,
            poop: `data:image/svg+xml;utf8,${encodeURIComponent('<svg width="80" height="80" xmlns="http://www.w3.org/2000/svg"><path d="M40,70 C20,70 10,60 10,40 C10,20 30,10 40,5 C50,10 70,20 70,40 C70,60 60,70 40,70 Z" fill="FILL_COLOR"/><circle cx="30" cy="40" r="4" fill="white"/><circle cx="30" cy="40" r="2" fill="black"/><circle cx="50" cy="40" r="4" fill="white"/><circle cx="50" cy="40" r="2" fill="black"/></svg>')}`
        };

        // å…³å¡é…ç½® (ä¿®å¤äº†è¿›åº¦ä¸åˆç†çš„é—®é¢˜)
        const LEVEL_CONFIG = {
            farm:   { max: 5,  xp: 10 },
            road:   { max: 10, xp: 15 },
            bikini: { max: 15, xp: 20 }, 
            cotton: { max: 20, xp: 20 }, // é™ä½äº†æ¸¸ä¹å›­çš„éš¾åº¦
            moon:   { max: 99, xp: 40 } 
        };

        const IMAGES = { bg: {}, poops: {} };
        const AUDIO = { bgm1: null, bgm2: null, current: null, isMuted: false };
        let loadedCount = 0;
        // åªå¼ºåˆ¶æ£€æŸ¥èƒŒæ™¯å›¾å’Œä¸»è§’å›¾ï¼ŒéŸ³é¢‘å¼‚æ­¥åŠ è½½ä¸å¡æµç¨‹
        const requiredAssets = 7; 

        /* ================= èµ„æºåŠ è½½å™¨ ================= */
        function checkLoad() {
            loadedCount++;
            if(loadedCount >= requiredAssets) {
                const btn = document.getElementById('startBtn');
                btn.innerText = "START";
                btn.disabled = false;
                document.getElementById('loading-text').style.display = 'none';
            }
        }

        // åŠ è½½å›¾ç‰‡çš„é€šç”¨å‡½æ•° (å¸¦è‡ªåŠ¨æ›¿è¡¥åŠŸèƒ½)
        function loadImgWithBackup(src, backupSrc, onLoadCallback) {
            const img = new Image();
            img.onload = onLoadCallback;
            img.onerror = () => {
                console.warn(`åŠ è½½å¤±è´¥: ${src}ï¼Œå·²åˆ‡æ¢ä¸ºå†…ç½®çŸ¢é‡å›¾ã€‚è¯·æ£€æŸ¥GitHubæ–‡ä»¶åå¤§å°å†™ï¼`);
                img.src = backupSrc; // è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ä»½ SVG
            };
            img.src = src;
            return img;
        }

        function initAssets() {
            // 1. åŠ è½½çŒª (å¦‚æœ pig.png æŒ‚äº†ï¼Œè‡ªåŠ¨ç”¨ç²‰è‰² SVG)
            IMAGES.pig = loadImgWithBackup(PATHS.pig, BACKUP_SVG.pig, checkLoad);

            // 2. åŠ è½½å± (é¢„ç”Ÿæˆå¤šè‰²ï¼Œå¦‚æœ poop.png æŒ‚äº†ï¼Œè‡ªåŠ¨ç”¨ SVG)
            // æŠ€å·§ï¼šæˆ‘ä»¬å…ˆåŠ è½½ä¸€æ¬¡åŸå›¾ï¼ŒæˆåŠŸåå†ç”Ÿæˆå˜è‰²ç‰ˆæœ¬
            const basePoop = new Image();
            basePoop.onload = () => {
                // åŸå›¾åŠ è½½æˆåŠŸï¼Œç”Ÿæˆå˜è‰²ç‰ˆ (è¿™é‡Œç®€åŒ–å¤„ç†ï¼Œç›´æ¥ç”¨åŸå›¾ + CSSæ»¤é•œï¼Œæ‰€ä»¥åªå­˜åŸå›¾å³å¯)
                IMAGES.poop = basePoop;
                checkLoad();
            };
            basePoop.onerror = () => {
                console.warn(`åŠ è½½å¤±è´¥: ${PATHS.poop}ï¼Œå·²åˆ‡æ¢ä¸ºå†…ç½®çŸ¢é‡å›¾ã€‚`);
                // åŠ è½½å¤±è´¥ï¼Œç”ŸæˆåŸºäº SVG çš„å¤šè‰²å±
                const colors = { normal:'#8B5E3C', speed:'#0984e3', boom:'#e74c3c', gold:'#f1c40f', stinky:'#00b894', sticky:'#6c5ce7' };
                for(let k in colors) {
                    IMAGES.poops[k] = new Image();
                    IMAGES.poops[k].src = BACKUP_SVG.poop.replace('FILL_COLOR', colors[k]);
                }
                // æ ‡è®°ä½¿ç”¨ SVG æ¨¡å¼
                IMAGES.useSVG = true; 
                checkLoad();
            };
            basePoop.src = PATHS.poop;

            // 3. åŠ è½½èƒŒæ™¯
            ['farm','road','bikini','cotton','moon'].forEach(k => {
                IMAGES.bg[k] = new Image();
                IMAGES.bg[k].src = PATHS['bg_'+k];
                IMAGES.bg[k].onload = checkLoad;
                IMAGES.bg[k].onerror = () => { 
                    console.warn("èƒŒæ™¯ç¼ºå¤±:", k); 
                    checkLoad(); // å³ä½¿èƒŒæ™¯ç¼ºå¤±ä¹Ÿå…è®¸å¼€å§‹æ¸¸æˆ (æ˜¾ç¤ºçº¯è‰²)
                };
            });

            // 4. åŠ è½½éŸ³é¢‘ (HTML5 Audioï¼Œå…¼å®¹æ€§æœ€å¥½)
            AUDIO.bgm1 = new Audio(PATHS.music_1); AUDIO.bgm1.loop = true;
            AUDIO.bgm2 = new Audio(PATHS.music_2); AUDIO.bgm2.loop = true;
        }

        initAssets();

        /* ================= æ¸¸æˆé€»è¾‘ ================= */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const G_W = 1920, G_H = 1080;

        let state = {
            active: false,
            score: 0,
            level: 1,
            xp: 0,
            maxXp: 10,
            rainMode: false,
            rainTimer: 0,
            thunderTimer: 0,
            poopRainMode: false,
            poopRainTimer: 0,
            keys: { w:false, a:false, s:false, d:false },
            mouse: { x:null, y:null, active:false }
        };

        let pig = { x: G_W/2, y: G_H/2, vx:0, vy:0, faceLeft:false, buffs:{} };
        let poops = [];
        let particles = [];
        let moonRain = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // äº¤äº’ç›‘å¬
        window.addEventListener('keydown', e => state.keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => state.keys[e.key.toLowerCase()] = false);
        canvas.addEventListener('pointerdown', e => { 
            state.mouse.active=true; updateMouse(e); 
            // ç‚¹å‡»å±å¹•æ—¶å°è¯•æ’­æ”¾éŸ³ä¹ (è§£å†³æµè§ˆå™¨è‡ªåŠ¨æ’­æ”¾é™åˆ¶)
            if(state.active && !AUDIO.isMuted && AUDIO.current && AUDIO.current.paused) AUDIO.current.play();
        });
        canvas.addEventListener('pointermove', e => { if(state.mouse.active) updateMouse(e); });
        canvas.addEventListener('pointerup', () => state.mouse.active=false);

        function updateMouse(e) {
            let scale = Math.min(canvas.width/G_W, canvas.height/G_H);
            let dx = (canvas.width - G_W*scale)/2;
            let dy = (canvas.height - G_H*scale)/2;
            state.mouse.x = (e.clientX - dx)/scale;
            state.mouse.y = (e.clientY - dy)/scale;
        }

        function playMusic(id) {
            if(AUDIO.isMuted) return;
            let target = id === 1 ? AUDIO.bgm1 : AUDIO.bgm2;
            let other = id === 1 ? AUDIO.bgm2 : AUDIO.bgm1;

            if(AUDIO.current !== target) {
                other.pause(); other.currentTime = 0;
                target.volume = 0.5;
                target.play().catch(e => console.log("è¯·ç‚¹å‡»å±å¹•å¼€å§‹æ’­æ”¾éŸ³ä¹"));
                AUDIO.current = target;
            }
        }

        function toggleMute() {
            AUDIO.isMuted = !AUDIO.isMuted;
            document.getElementById('muteBtn').innerText = AUDIO.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            if(AUDIO.isMuted) { if(AUDIO.current) AUDIO.current.pause(); }
            else { if(AUDIO.current) AUDIO.current.play(); }
        }

        function startGame() {
            state.active = true;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('uiLayer').style.opacity = 1;
            playMusic(1);
            gameLoop();
            spawner();
        }

        function gameLoop() {
            if(!state.active) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            const scene = getScene();

            // 1. çŒªçš„è¿åŠ¨
            let speed = 12 + (state.level * 0.4); // åŸºç¡€é€Ÿåº¦æå‡
            if(scene === 'moon') speed = 25; // æœˆçƒè¶…çº§åŠ é€Ÿ (æ»¡è¶³ä½ çš„éœ€æ±‚)

            if(pig.buffs.speed > 0) { speed *= 2; pig.buffs.speed--; }
            if(pig.buffs.slow > 0) { speed *= 0.5; pig.buffs.slow--; }
            if(pig.buffs.dizzy > 0) { 
                pig.buffs.dizzy--; 
                pig.vx += (Math.random()-0.5)*5; 
                pig.vy += (Math.random()-0.5)*5;
            }

            let ax = 0, ay = 0;
            if(state.keys.w || state.keys.arrowup) ay = -1;
            if(state.keys.s || state.keys.arrowdown) ay = 1;
            if(state.keys.a || state.keys.arrowleft) ax = -1;
            if(state.keys.d || state.keys.arrowright) ax = 1;
            
            if(state.mouse.active) {
                let ang = Math.atan2(state.mouse.y - pig.y, state.mouse.x - pig.x);
                ax = Math.cos(ang); ay = Math.sin(ang);
            }

            pig.vx += ax * 2; pig.vy += ay * 2;
            pig.vx *= 0.9; pig.vy *= 0.9;
            
            let v = Math.hypot(pig.vx, pig.vy);
            if(v > speed) { pig.vx = (pig.vx/v)*speed; pig.vy = (pig.vy/v)*speed; }

            pig.x += pig.vx; pig.y += pig.vy;
            if(pig.x < 50) pig.x = 50; if(pig.x > G_W-50) pig.x = G_W-50;
            if(pig.y < 50) pig.y = 50; if(pig.y > G_H-50) pig.y = G_H-50;
            
            if(pig.vx < -0.5) pig.faceLeft = false; 
            if(pig.vx > 0.5) pig.faceLeft = true;

            // 2. ç‰©å“é€»è¾‘
            if(state.poopRainMode) {
                state.poopRainTimer--;
                if(state.poopRainTimer <= 0) state.poopRainMode = false;
            }

            for(let i=poops.length-1; i>=0; i--) {
                let p = poops[i];
                if(p.scale < (p.type==='giant'?3:1)) p.scale += 0.05;

                // ç£é“å¸é™„
                if(state.level >= 5 && p.type !== 'stinky' && p.type !== 'sticky') {
                    let d = Math.hypot(p.x - pig.x, p.y - pig.y);
                    if(d < 350) {
                        p.x += (pig.x - p.x) * 0.1;
                        p.y += (pig.y - p.y) * 0.1;
                    }
                }

                // ç¢°æ’
                let hitR = 80 + state.level;
                if(p.type === 'giant') hitR = 160;
                if(Math.hypot(p.x - pig.x, p.y - pig.y) < hitR) eat(p, i);
            }

            // 3. ç‰¹æ•ˆ
            if(scene === 'moon') {
                if(Math.random() < 0.01) state.thunderTimer = 6; // é›·æš´
                if(state.thunderTimer > 0) state.thunderTimer--;
                // æœˆçƒé›¨
                if(Math.random() < 0.4) moonRain.push({x:Math.random()*G_W, y:-50, v:Math.random()*30+20});
                for(let i=moonRain.length-1; i>=0; i--) {
                    moonRain[i].y += moonRain[i].v; moonRain[i].x -= 2;
                    if(moonRain[i].y > G_H) moonRain.splice(i, 1);
                }
            }

            for(let i=particles.length-1; i>=0; i--) {
                let pt = particles[i];
                pt.x += pt.vx; pt.y += pt.vy; pt.life -= 0.03;
                if(pt.life <= 0) particles.splice(i, 1);
            }
        }

        function eat(p, idx) {
            poops.splice(idx, 1);
            
            let val = 1; let scoreAdd = 10;
            let color = "#8B5E3C";

            if(p.type === 'gold') { val=3; scoreAdd=50; color='#f1c40f'; }
            if(p.type === 'giant') { val=10; scoreAdd=500; color='#f1c40f'; }
            if(p.type === 'speed') { pig.buffs.speed = 300; color='#0984e3'; showMsg("âš¡ åŠ é€Ÿ!"); }
            if(p.type === 'boom') { 
                color='#e74c3c'; createExplosion(p.x, p.y);
                poops.forEach(o => {
                    if(Math.hypot(o.x - pig.x, o.y - pig.y) < 600) {
                        o.x = pig.x; o.y = pig.y;
                    }
                });
                showMsg("ğŸ’¥ ç‚¸è£‚!");
            }
            if(p.type === 'stinky') { pig.buffs.dizzy = 120; color='#00b894'; if(state.level < 10) showMsg("ğŸ¤¢ å¥½æ™•!"); }
            if(p.type === 'sticky') { pig.buffs.slow = 120; color='#6c5ce7'; showMsg("ğŸ•¸ï¸ é»ä½!"); }

            state.xp += val;
            state.score += scoreAdd;
            createParticles(p.x, p.y, color);

            if(state.xp >= state.maxXp) levelUp();
            updateUI();
        }

        function levelUp() {
            state.level++;
            state.xp = 0;
            let conf = getLevelConfig();
            state.maxXp = conf.xp;

            if(state.level === 6) showMsg("æ–°åœºæ™¯: å…¬è·¯!");
            if(state.level === 11) showMsg("æ–°åœºæ™¯: æ¯”å¥‡å ¡!");
            if(state.level === 16) showMsg("æ–°åœºæ™¯: æ¸¸ä¹å›­!");
            if(state.level === 21) {
                showMsg("è¿›å…¥æœˆçƒ!", "é‡åŠ›å¤±æ§!");
                playMusic(2);
            } else {
                showMsg("LEVEL UP!");
            }
        }

        function getLevelConfig() {
            if(state.level <= 5) return { xp: 10 };
            if(state.level <= 10) return { xp: 20 };
            if(state.level <= 15) return { xp: 30 };
            if(state.level <= 20) return { xp: 30 }; // é™ä½åæœŸéš¾åº¦
            return { xp: 100 };
        }

        function getScene() {
            if(state.level <= 5) return 'farm';
            if(state.level <= 10) return 'road';
            if(state.level <= 15) return 'bikini';
            if(state.level <= 20) return 'cotton';
            return 'moon';
        }

        function spawner() {
            if(!state.active) return;
            let delay = 700;
            if(state.poopRainMode) delay = 60; // å¤§ä¾¿é›¨é€Ÿåº¦æå¿«

            setTimeout(() => {
                spawn();
                spawner();
            }, delay);
        }

        function spawn() {
            let maxItems = 12 + state.level;
            if(state.poopRainMode) maxItems = 80;
            if(poops.length >= maxItems) return;

            // éšæœºå¤§ä¾¿é›¨ (è°ƒé«˜æ¦‚ç‡)
            if(!state.poopRainMode && Math.random() < 0.008) { 
                state.poopRainMode = true;
                state.poopRainTimer = 400;
                showMsg("ğŸ’© å¤§ä¾¿é›¨æ¥è¢­!", "ç‹‚æ¬¢æ—¶åˆ»!");
            }

            let type = 'normal';
            let r = Math.random();
            // å¢åŠ ç‰¹æ®Šé“å…·æ¦‚ç‡
            if(r < 0.03) type = 'giant';
            else if(r < 0.09) type = 'speed';
            else if(r < 0.15) type = 'boom';
            else if(r < 0.21) type = 'gold';
            else if(r < 0.26) type = 'stinky';
            else if(r < 0.31) type = 'sticky';

            poops.push({
                x: Math.random()*(G_W-100)+50,
                y: Math.random()*(G_H-100)+50,
                type: type,
                scale: 0,
                float: Math.random()*100
            });
        }

        function createExplosion(x, y) {
            for(let i=0; i<25; i++) {
                particles.push({
                    x:x, y:y, vx:(Math.random()-0.5)*30, vy:(Math.random()-0.5)*30,
                    life:1.5, color:'#e74c3c'
                });
            }
        }

        function createParticles(x, y, color) {
            for(let i=0; i<8; i++) {
                particles.push({
                    x:x, y:y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15,
                    life:1, color:color
                });
            }
        }

        function showMsg(t1, t2="") {
            const t = document.getElementById('toast');
            t.innerHTML = `<div>${t1}</div><div style="font-size:20px">${t2}</div>`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function updateUI() {
            document.getElementById('scoreVal').innerText = state.score;
            let names = {farm:'å†œåœº', road:'å…¬è·¯', bikini:'æ¯”å¥‡å ¡', cotton:'æ¸¸ä¹å›­', moon:'æœˆçƒ'};
            document.getElementById('levelVal').innerText = `Lv.${state.level} ${names[getScene()]}`;
            document.getElementById('xpFill').style.width = `${(state.xp/state.maxXp)*100}%`;
        }

        /* ================= æ¸²æŸ“ ================= */
        function draw() {
            let s = Math.min(canvas.width/G_W, canvas.height/G_H);
            let dx = (canvas.width - G_W*s)/2;
            let dy = (canvas.height - G_H*s)/2;

            ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.save();
            ctx.translate(dx, dy); ctx.scale(s, s);
            ctx.beginPath(); ctx.rect(0,0,G_W,G_H); ctx.clip();

            const scene = getScene();
            let bgImg = IMAGES.bg[scene];

            // 1. èƒŒæ™¯
            if(bgImg && bgImg.complete && bgImg.naturalWidth !== 0) {
                ctx.drawImage(bgImg, 0, 0, G_W, G_H);
            } else {
                // å…œåº•èƒŒæ™¯ (é˜²æ­¢é»‘å±)
                ctx.fillStyle = scene==='moon' ? '#2c3e50' : '#27ae60';
                ctx.fillRect(0,0,G_W,G_H);
            }

            // 2. æœˆçƒé›·æš´
            if(scene === 'moon' && state.lightningTimer > 0) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.6})`;
                ctx.fillRect(0,0,G_W,G_H);
            }

            // 3. ç»˜åˆ¶ç‰©å“
            poops.forEach(p => {
                let hover = Math.sin((Date.now()/200)+p.float) * 5;
                ctx.save();
                ctx.translate(p.x, p.y + hover);
                let sc = p.type === 'giant' ? 3 : 1;
                ctx.scale(p.scale * sc, p.scale * sc);

                // é¢œè‰²æ»¤é•œ (å¦‚æœç”¨çš„æ˜¯ poop.png)
                if(!IMAGES.useSVG) {
                    if(p.type === 'boom') ctx.filter = "hue-rotate(320deg) saturate(300%)"; 
                    if(p.type === 'speed') ctx.filter = "hue-rotate(200deg) brightness(1.2)"; 
                    if(p.type === 'stinky') ctx.filter = "hue-rotate(120deg)"; 
                    if(p.type === 'sticky') ctx.filter = "hue-rotate(260deg)"; 
                    if(p.type === 'gold' || p.type === 'giant') ctx.filter = "sepia(100%) brightness(1.5)";
                }
                
                // é˜´å½±
                ctx.fillStyle = "rgba(0,0,0,0.2)";
                ctx.beginPath(); ctx.ellipse(0, 35, 30, 10, 0,0,Math.PI*2); ctx.fill();

                // ç»˜åˆ¶
                let drawImg = IMAGES.poop;
                if(IMAGES.useSVG) drawImg = IMAGES.poops[p.type] || IMAGES.poops.normal; // å¤‡ç”¨SVGæ¨¡å¼

                if(drawImg && drawImg.complete) ctx.drawImage(drawImg, -40, -40, 80, 80);
                ctx.restore();
            });

            // 4. ç»˜åˆ¶çŒª
            ctx.save();
            ctx.translate(pig.x, pig.y);
            let pScale = 1 + (state.level * 0.05);
            if(pig.faceLeft) ctx.scale(-pScale, pScale); else ctx.scale(pScale, pScale);

            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.beginPath(); ctx.ellipse(0, 50, 60, 15, 0,0,Math.PI*2); ctx.fill();
            
            if(IMAGES.pig && IMAGES.pig.complete) ctx.drawImage(IMAGES.pig, -75, -60, 150, 120);

            // é¥°å“
            if(state.level >= 10) { 
                ctx.fillStyle = "black"; ctx.fillRect(-45, -12, 20, 10); ctx.fillRect(-20, -12, 20, 10);
                ctx.strokeStyle="black"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-25,-7); ctx.lineTo(-20,-7); ctx.stroke();
            }
            if(state.level >= 15) { 
                ctx.fillStyle = "#e74c3c"; ctx.beginPath(); ctx.moveTo(10, -20); ctx.lineTo(60, 20); ctx.lineTo(60, 60); ctx.lineTo(10, 40); ctx.fill();
            }
            ctx.restore();

            // 5. ç²’å­
            particles.forEach(pt => {
                ctx.globalAlpha = pt.life;
                ctx.fillStyle = pt.color || "white";
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 8, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // 6. æœˆçƒé›¨
            if(scene === 'moon') {
                ctx.strokeStyle = "rgba(200,200,255,0.5)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                moonRain.forEach(r => {
                    ctx.moveTo(r.x, r.y); ctx.lineTo(r.x-5, r.y+r.v);
                });
                ctx.stroke();
            }

            // 7. æ»¤é•œ
            const fx = document.getElementById('fx-layer');
            if(pig.buffs.dizzy > 0) fx.className = 'dizzy';
            else if(state.lightningTimer > 0) fx.className = 'flash';
            else fx.className = '';

            ctx.restore();
        }
    </script>
</body>
</html>
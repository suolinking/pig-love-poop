<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pig Love Poop</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        :root {
            --primary: #ff9ff3;
            --dark: #222f3e;
        }

        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            font-family: 'Fredoka One', cursive, sans-serif;
            touch-action: none; /* ç¦æ­¢æ‰‹æœºç«¯ç¼©æ”¾ */
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            overflow: hidden;
        }

        canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* --- UI å±‚ --- */
        .ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 10;
            transition: opacity 0.5s;
        }

        .header {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: flex-start;
        }

        .score-box {
            background: rgba(255,255,255,0.9);
            border: 4px solid var(--primary);
            border-radius: 15px;
            padding: 10px 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .score-val { font-size: 32px; color: #2d3436; line-height: 1; }
        .level-val { font-size: 14px; color: #666; }

        .mute-btn {
            pointer-events: auto;
            background: rgba(0,0,0,0.6);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
        }

        .xp-bar-container {
            width: 100%;
            height: 12px;
            background: rgba(0,0,0,0.5);
            position: absolute;
            bottom: 0; left: 0;
            border-top: 2px solid rgba(255,255,255,0.3);
        }
        .xp-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #f1c40f, #e67e22);
            transition: width 0.2s;
        }

        /* --- å¯åŠ¨ç•Œé¢ --- */
        #start-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s, transform 0.5s;
        }
        #start-screen.hidden { opacity: 0; pointer-events: none; transform: scale(1.1); }

        h1 {
            font-size: 5rem; color: white; margin: 0;
            text-shadow: 0 0 20px #ff9ff3, 0 0 40px #ff9ff3;
            font-weight: 400; letter-spacing: 3px;
            z-index: 2;
            text-align: center;
        }

        .btn-start {
            margin-top: 50px;
            background: transparent;
            color: white;
            border: 2px solid white;
            padding: 15px 60px;
            font-size: 1.5rem;
            font-family: inherit;
            cursor: pointer;
            transition: 0.3s;
            z-index: 2;
            border-radius: 50px;
        }
        .btn-start:hover { background: white; color: black; box-shadow: 0 0 20px white; }
        .btn-start:disabled { opacity: 0.5; cursor: not-allowed; border-color: #555; color: #888; box-shadow: none; }

        #loading-text { margin-top: 20px; color: #888; font-size: 14px; }

        /* --- ç‰¹æ•ˆå±‚ --- */
        #fx-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            mix-blend-mode: overlay;
            transition: background 0.1s;
            z-index: 5;
        }
        .flash { background-color: rgba(255,255,255,0.8) !important; }
        .dizzy { backdrop-filter: blur(4px) hue-rotate(90deg); }

        /* å‡çº§æç¤º */
        #toast {
            position: absolute; top: 30%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #ff9ff3, #feca57);
            padding: 15px 30px; border-radius: 30px;
            color: white; font-size: 24px; border: 4px solid #fff;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            opacity: 0; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 20; text-align: center; white-space: nowrap;
        }
        #toast.show { transform: translate(-50%, -50%) scale(1); opacity: 1; }

    </style>
</head>
<body>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="fx-layer"></div>

        <div class="ui-layer" id="uiLayer" style="opacity:0">
            <div class="header">
                <div class="score-box">
                    <div class="score-val" id="scoreVal">0</div>
                    <div class="level-val" id="levelVal">Lv.1 å†œåœº</div>
                </div>
                <div class="mute-btn" onclick="toggleMute()" id="muteBtn">ğŸ”Š</div>
            </div>
            <div class="xp-bar-container">
                <div class="xp-fill" id="xpFill"></div>
            </div>
        </div>

        <div id="toast">LEVEL UP!</div>

        <div id="start-screen">
            <h1>pig love poop</h1>
            <button class="btn-start" id="startBtn" onclick="startGame()" disabled>Loading...</button>
            <div id="loading-text">èµ„æºåŠ è½½ä¸­ (0/7)</div>
        </div>
    </div>

    <script>
        /* ================= é…ç½® ================= */
        const PATHS = {
            pig:       "assets/pig.png",
            poop:      "assets/poop.png",
            bg_farm:   "assets/bg_farm.png",
            bg_road:   "assets/bg_road.png",
            bg_bikini: "assets/bg_bikini.png",
            bg_cotton: "assets/bg_cotton.png",
            bg_moon:   "assets/bg_moon.png",
            music_1:   "assets/music_1.mp3",
            music_2:   "assets/music_2.mp3"
        };

        // å…³å¡é…ç½®ï¼šè°ƒæ•´äº†æ¯å…³éœ€è¦çš„ç»éªŒï¼Œé˜²æ­¢å€’æ•°ç¬¬äºŒå…³å¤ªé•¿
        const LEVEL_CONFIG = {
            farm:   { min: 1,  max: 5,  xp: 10 }, // 1-5çº§ï¼Œæ¯çº§10åˆ†
            road:   { min: 6,  max: 10, xp: 15 }, // 6-10çº§ï¼Œæ¯çº§15åˆ†
            bikini: { min: 11, max: 15, xp: 20 }, 
            cotton: { min: 16, max: 20, xp: 25 }, // å€’æ•°ç¬¬äºŒå¤§å…³ï¼Œæ¯çº§25åˆ†ï¼ˆä¹‹å‰å¯èƒ½å¤ªé«˜äº†ï¼‰
            moon:   { min: 21, max: 99, xp: 50 }  // æœˆçƒï¼Œæ¯çº§50åˆ†
        };

        const IMAGES = {};
        const AUDIO = { ctx: null, buffers: {}, source: null, isMuted: false };
        let loadedCount = 0;
        const totalAssets = Object.keys(PATHS).length;

        /* ================= èµ„æºåŠ è½½ ================= */
        function checkLoad() {
            loadedCount++;
            document.getElementById('loading-text').innerText = `èµ„æºåŠ è½½ä¸­ (${loadedCount}/${totalAssets})`;
            if(loadedCount >= totalAssets) {
                const btn = document.getElementById('startBtn');
                btn.innerText = "START";
                btn.disabled = false;
                document.getElementById('loading-text').style.display = 'none';
            }
        }

        // åŠ è½½å›¾ç‰‡
        ['pig','poop','bg_farm','bg_road','bg_bikini','bg_cotton','bg_moon'].forEach(k => {
            IMAGES[k] = new Image();
            IMAGES[k].src = PATHS[k];
            IMAGES[k].onload = checkLoad;
            IMAGES[k].onerror = () => { console.error("åŠ è½½å¤±è´¥:", PATHS[k]); checkLoad(); }; // å¤±è´¥ä¹Ÿç»§ç»­ï¼Œé˜²æ­¢å¡æ­»
        });

        // åŠ è½½éŸ³é¢‘
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        AUDIO.ctx = new AudioContext();
        
        ['music_1', 'music_2'].forEach((key, idx) => {
            fetch(PATHS[key])
                .then(res => res.arrayBuffer())
                .then(buf => AUDIO.ctx.decodeAudioData(buf))
                .then(decoded => {
                    AUDIO.buffers[idx + 1] = decoded;
                    checkLoad();
                })
                .catch(e => { console.warn("éŸ³é¢‘åŠ è½½å¤±è´¥ (å¯èƒ½æ˜¯æœ¬åœ°è·¨åŸŸé™åˆ¶):", e); checkLoad(); });
        });

        /* ================= æ¸¸æˆç³»ç»Ÿ ================= */
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const G_W = 1920, G_H = 1080;

        let state = {
            active: false,
            score: 0,
            level: 1,
            xp: 0,
            maxXp: 10,
            rainMode: false,
            rainTimer: 0,
            thunderTimer: 0,
            keys: { w:false, a:false, s:false, d:false },
            mouse: { x:null, y:null, active:false }
        };

        let pig = { x: G_W/2, y: G_H/2, vx:0, vy:0, faceLeft:false, buffs:{} };
        let poops = [];
        let particles = [];
        let moonRain = [];

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // è¾“å…¥
        window.addEventListener('keydown', e => state.keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => state.keys[e.key.toLowerCase()] = false);
        canvas.addEventListener('pointerdown', e => { state.mouse.active=true; updateMouse(e); if(AUDIO.ctx.state==='suspended') AUDIO.ctx.resume(); });
        canvas.addEventListener('pointermove', e => { if(state.mouse.active) updateMouse(e); });
        canvas.addEventListener('pointerup', () => state.mouse.active=false);

        function updateMouse(e) {
            let s = Math.min(canvas.width/G_W, canvas.height/G_H);
            let dx = (canvas.width - G_W*s)/2;
            let dy = (canvas.height - G_H*s)/2;
            state.mouse.x = (e.clientX - dx)/s;
            state.mouse.y = (e.clientY - dy)/s;
        }

        function playMusic(id) {
            if(AUDIO.isMuted || !AUDIO.buffers[id]) return;
            if(AUDIO.source) try{ AUDIO.source.stop(); }catch(e){}
            const src = AUDIO.ctx.createBufferSource();
            src.buffer = AUDIO.buffers[id];
            src.loop = true;
            const gain = AUDIO.ctx.createGain();
            gain.gain.value = 0.4;
            src.connect(gain);
            gain.connect(AUDIO.ctx.destination);
            src.start(0);
            AUDIO.source = src;
        }

        function toggleMute() {
            AUDIO.isMuted = !AUDIO.isMuted;
            document.getElementById('muteBtn').innerText = AUDIO.isMuted ? 'ğŸ”‡' : 'ğŸ”Š';
            if(AUDIO.isMuted && AUDIO.source) AUDIO.source.stop();
            else if(!AUDIO.isMuted) {
                if(state.level >= 21) playMusic(2); else playMusic(1);
            }
        }

        /* ================= ä¸»é€»è¾‘ ================= */
        function startGame() {
            state.active = true;
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('uiLayer').style.opacity = 1;
            playMusic(1);
            gameLoop();
            itemSpawner();
        }

        function gameLoop() {
            if(!state.active) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }

        function update() {
            const scene = getScene();

            // 1. çŒªç§»åŠ¨
            let baseSpeed = 10 + (state.level * 0.3);
            // --- ä¿®å¤4ï¼šæœˆçƒå…³åŠ é€Ÿ ---
            if(scene === 'moon') baseSpeed = 22; // æœˆçƒé€Ÿåº¦ç¿»å€
            
            if(pig.buffs.speed > 0) { baseSpeed *= 2; pig.buffs.speed--; }
            if(pig.buffs.slow > 0) { baseSpeed *= 0.5; pig.buffs.slow--; }
            if(pig.buffs.dizzy > 0) { 
                pig.buffs.dizzy--; 
                pig.vx += (Math.random()-0.5)*4;
                pig.vy += (Math.random()-0.5)*4;
            }

            let ax = 0, ay = 0;
            if(state.keys.w) ay = -1; if(state.keys.s) ay = 1;
            if(state.keys.a) ax = -1; if(state.keys.d) ax = 1;
            if(state.mouse.active) {
                let ang = Math.atan2(state.mouse.y - pig.y, state.mouse.x - pig.x);
                ax = Math.cos(ang); ay = Math.sin(ang);
            }

            pig.vx += ax * 2; pig.vy += ay * 2;
            pig.vx *= 0.9; pig.vy *= 0.9;
            
            let v = Math.hypot(pig.vx, pig.vy);
            if(v > baseSpeed) { pig.vx = (pig.vx/v)*baseSpeed; pig.vy = (pig.vy/v)*baseSpeed; }

            pig.x += pig.vx; pig.y += pig.vy;
            if(pig.x < 50) pig.x = 50; if(pig.x > G_W-50) pig.x = G_W-50;
            if(pig.y < 50) pig.y = 50; if(pig.y > G_H-50) pig.y = G_H-50;
            
            if(pig.vx < -0.5) pig.faceLeft = false; 
            if(pig.vx > 0.5) pig.faceLeft = true;

            // 2. å±æ›´æ–°
            // --- ä¿®å¤3ï¼šå¤§ä¾¿é›¨æŒç»­æ—¶é—´ ---
            if(state.rainMode) {
                state.rainTimer--;
                if(state.rainTimer <= 0) state.rainMode = false;
            }

            for(let i=poops.length-1; i>=0; i--) {
                let p = poops[i];
                if(p.scale < 1) p.scale += 0.05;
                
                // è‡ªåŠ¨å¸é™„ (Lv5+)
                if(state.level >= 5 && p.type !== 'stinky' && p.type !== 'sticky') {
                    let d = Math.hypot(p.x - pig.x, p.y - pig.y);
                    if(d < 300) {
                        p.x += (pig.x - p.x) * 0.1;
                        p.y += (pig.y - p.y) * 0.1;
                    }
                }

                // ç¢°æ’
                let hitR = 80 + state.level;
                if(p.type === 'giant') hitR = 150;

                if(Math.hypot(p.x - pig.x, p.y - pig.y) < hitR) {
                    eat(p, i);
                }
            }

            // 3. ç¯å¢ƒç‰¹æ•ˆ (æœˆçƒ)
            if(scene === 'moon') {
                if(Math.random() < 0.01) state.thunderTimer = 5; // é›·æš´é—ªçƒ
                if(state.thunderTimer > 0) state.thunderTimer--;
                
                // æœˆçƒé›¨
                if(Math.random() < 0.3) moonRain.push({x:Math.random()*G_W, y:-50, v:Math.random()*20+20});
                for(let i=moonRain.length-1; i>=0; i--) {
                    moonRain[i].y += moonRain[i].v;
                    moonRain[i].x -= 2;
                    if(moonRain[i].y > G_H) moonRain.splice(i, 1);
                }
            }

            // ç²’å­
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].x += particles[i].vx;
                particles[i].y += particles[i].vy;
                particles[i].life -= 0.03;
                if(particles[i].life <= 0) particles.splice(i, 1);
            }
        }

        function eat(p, idx) {
            poops.splice(idx, 1);
            let val = 1; let scoreAdd = 10;
            
            if(p.type === 'gold') { val=3; scoreAdd=50; }
            if(p.type === 'giant') { val=5; scoreAdd=200; }
            if(p.type === 'speed') { pig.buffs.speed = 300; showMsg("âš¡ åŠ é€Ÿ!"); }
            if(p.type === 'boom') { 
                // çˆ†ç‚¸å¸é™„
                poops.forEach(o => {
                    if(Math.hypot(o.x - pig.x, o.y - pig.y) < 600) {
                        o.x = pig.x; o.y = pig.y;
                    }
                });
                showMsg("ğŸ’¥ ç‚¸è£‚!");
            }
            if(p.type === 'stinky') { pig.buffs.dizzy = 120; }
            if(p.type === 'sticky') { pig.buffs.slow = 120; }

            state.score += scoreAdd;
            state.xp += val;
            
            for(let i=0; i<5; i++) {
                particles.push({
                    x: p.x, y: p.y, vx:(Math.random()-0.5)*15, vy:(Math.random()-0.5)*15,
                    life: 1, color: p.color
                });
            }

            if(state.xp >= state.maxXp) levelUp();
            updateUI();
        }

        function levelUp() {
            state.level++;
            state.xp = 0;
            
            // --- ä¿®å¤5ï¼šå¹³æ»‘çš„å‡çº§æ›²çº¿ ---
            let conf = getLevelConfig();
            state.maxXp = conf.xp; 

            if(state.level === 6) showMsg("æ–°åœºæ™¯: å…¬è·¯!");
            if(state.level === 11) showMsg("æ–°åœºæ™¯: æ¯”å¥‡å ¡!");
            if(state.level === 16) showMsg("æ–°åœºæ™¯: æ¸¸ä¹å›­!");
            if(state.level === 21) {
                showMsg("è­¦å‘Š: è¿›å…¥æœˆçƒ!", "é‡åŠ›å¼‚å¸¸!");
                playMusic(2);
            } else {
                showMsg("LEVEL UP!");
            }
        }

        function getLevelConfig() {
            if(state.level <= 5) return { xp: 15 }; // å†œåœº
            if(state.level <= 10) return { xp: 25 }; // å…¬è·¯
            if(state.level <= 15) return { xp: 35 }; // æ¯”å¥‡å ¡
            if(state.level <= 20) return { xp: 45 }; // æ¸¸ä¹å›­
            return { xp: 100 }; // æœˆçƒ (å¾ˆéš¾å‡çº§)
        }

        function getScene() {
            if(state.level <= 5) return 'farm';
            if(state.level <= 10) return 'road';
            if(state.level <= 15) return 'bikini';
            if(state.level <= 20) return 'cotton';
            return 'moon';
        }

        function itemSpawner() {
            if(!state.active) return;
            
            let delay = 800;
            if(state.rainMode) delay = 80; // å±é›¨æ¨¡å¼ï¼šæå¿«ç”Ÿæˆ

            setTimeout(() => {
                spawn();
                itemSpawner();
            }, delay);
        }

        function spawn() {
            let maxItems = 8 + state.level;
            if(state.rainMode) maxItems = 60;
            if(poops.length >= maxItems) return;

            // --- ä¿®å¤3ï¼šæé«˜å¤§ä¾¿é›¨æ¦‚ç‡ ---
            // ä¹‹å‰æ˜¯ 0.002ï¼Œç°åœ¨æ”¹ä¸º 0.005 (æ¯ç§’æ£€æµ‹å¤šæ¬¡ï¼Œå¤§çº¦30ç§’-1åˆ†é’Ÿè§¦å‘ä¸€æ¬¡)
            if(!state.rainMode && Math.random() < 0.005) {
                state.rainMode = true;
                state.rainTimer = 500; // æŒç»­æ—¶é—´
                showMsg("ğŸ’© å¤§ä¾¿é›¨æ¥è¢­!", "ç‹‚æ¬¢æ—¶åˆ»!");
            }

            let type = 'normal';
            let color = null; // null ä½¿ç”¨åŸå›¾é¢œè‰²ï¼Œå¦åˆ™ç”¨æ»¤é•œ
            let r = Math.random();

            if(r < 0.02) { type = 'giant'; color = 'gold'; }
            else if(r < 0.07) { type = 'speed'; color = 'blue'; }
            else if(r < 0.12) { type = 'boom'; color = 'red'; }
            else if(r < 0.17) { type = 'gold'; color = 'gold'; }
            else if(r < 0.22) { type = 'stinky'; color = 'green'; }
            else if(r < 0.27) { type = 'sticky'; color = 'purple'; }

            // åœºæ™¯ç‰¹è‰² (å‡å®šæ™®é€šå±åœ¨ä¸åŒåœºæ™¯æœ‰å˜ç§ï¼Œè¿™é‡Œç®€åŒ–é€»è¾‘)
            
            poops.push({
                x: Math.random()*(G_W-100)+50,
                y: Math.random()*(G_H-100)+50,
                type: type,
                colorTag: color, // ç”¨äºç»˜å›¾æ»¤é•œ
                scale: 0,
                float: Math.random()*100
            });
        }

        function showMsg(t1, t2="") {
            const t = document.getElementById('toast');
            t.innerHTML = `<div>${t1}</div><div style="font-size:20px">${t2}</div>`;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 2000);
        }

        function updateUI() {
            document.getElementById('scoreVal').innerText = state.score;
            let mapNames = {farm:'å†œåœº', road:'å…¬è·¯', bikini:'æ¯”å¥‡å ¡', cotton:'æ¸¸ä¹å›­', moon:'æœˆçƒ'};
            document.getElementById('levelVal').innerText = `Lv.${state.level} ${mapNames[getScene()]}`;
            document.getElementById('xpFill').style.width = `${(state.xp/state.maxXp)*100}%`;
        }

        /* ================= æ¸²æŸ“ ================= */
        function draw() {
            let s = Math.min(canvas.width/G_W, canvas.height/G_H);
            let dx = (canvas.width - G_W*s)/2;
            let dy = (canvas.height - G_H*s)/2;

            ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.save();
            ctx.translate(dx, dy); ctx.scale(s, s);
            ctx.beginPath(); ctx.rect(0,0,G_W,G_H); ctx.clip();

            let scene = getScene();

            // 1. èƒŒæ™¯ (ç¡®ä¿ä¸é»‘å±)
            if(IMAGES.bg[scene] && IMAGES.bg[scene].complete) {
                ctx.drawImage(IMAGES.bg[scene], 0, 0, G_W, G_H);
            } else {
                // å…œåº•è‰²å—
                ctx.fillStyle = scene==='moon' ? '#2c3e50' : '#27ae60';
                ctx.fillRect(0,0,G_W,G_H);
            }

            // 2. æœˆçƒé›·æš´
            if(scene === 'moon' && state.thunderTimer > 0) {
                ctx.fillStyle = `rgba(255,255,255,${Math.random()*0.5})`;
                ctx.fillRect(0,0,G_W,G_H);
            }

            // 3. å±
            poops.forEach(p => {
                let hover = Math.sin((Date.now()/200)+p.float) * 5;
                ctx.save();
                ctx.translate(p.x, p.y + hover);
                let sc = p.type === 'giant' ? 2.5 : 1;
                ctx.scale(p.scale * sc, p.scale * sc);
                
                // é¢œè‰²æ»¤é•œé€»è¾‘
                if(p.colorTag === 'red') ctx.filter = "hue-rotate(320deg) saturate(200%)"; // å˜çº¢
                if(p.colorTag === 'blue') ctx.filter = "hue-rotate(200deg)"; // å˜è“
                if(p.colorTag === 'green') ctx.filter = "hue-rotate(100deg)"; // å˜ç»¿
                if(p.colorTag === 'purple') ctx.filter = "hue-rotate(260deg)"; // å˜ç´«
                if(p.colorTag === 'gold') ctx.filter = "brightness(150%) sepia(100%)"; // å˜é‡‘

                // å½±å­
                ctx.fillStyle = "rgba(0,0,0,0.3)";
                ctx.beginPath(); ctx.ellipse(0, 35, 30, 10, 0,0,Math.PI*2); ctx.fill();

                if(IMAGES.poop.complete) ctx.drawImage(IMAGES.poop, -40, -40, 80, 80);
                ctx.restore();
            });

            // 4. çŒª
            ctx.save();
            ctx.translate(pig.x, pig.y);
            let pScale = 1 + (state.level * 0.05);
            if(pig.faceLeft) ctx.scale(-pScale, pScale); else ctx.scale(pScale, pScale);
            
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.beginPath(); ctx.ellipse(0, 50, 60, 15, 0,0,Math.PI*2); ctx.fill();

            if(IMAGES.pig.complete) ctx.drawImage(IMAGES.pig, -75, -60, 150, 120);

            // è¿›åŒ–å¤–è§‚
            if(state.level >= 10) { // å¢¨é•œ
                ctx.fillStyle = "black";
                ctx.fillRect(-55, -20, 25, 12); ctx.fillRect(-25, -20, 25, 12);
                ctx.strokeStyle="black"; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-30,-15); ctx.lineTo(-25,-15); ctx.stroke();
            }
            if(state.level >= 15) { // æŠ«é£
                ctx.fillStyle = "#e74c3c";
                ctx.beginPath(); ctx.moveTo(20,-40); ctx.lineTo(80,10); ctx.lineTo(80,80); ctx.lineTo(20,50); ctx.fill();
            }
            ctx.restore();

            // 5. ç²’å­
            particles.forEach(pt => {
                ctx.globalAlpha = pt.life;
                ctx.fillStyle = pt.color || "white";
                ctx.beginPath(); ctx.arc(pt.x, pt.y, 8, 0, Math.PI*2); ctx.fill();
            });
            ctx.globalAlpha = 1;

            // 6. æœˆçƒé›¨
            if(scene === 'moon') {
                ctx.strokeStyle = "rgba(200,200,255,0.5)";
                ctx.lineWidth = 2;
                ctx.beginPath();
                moonRain.forEach(r => {
                    ctx.moveTo(r.x, r.y); ctx.lineTo(r.x-5, r.y+r.v);
                });
                ctx.stroke();
            }

            // 7. å±å¹•ç‰¹æ•ˆ
            const fx = document.getElementById('fx-layer');
            if(pig.buffs.dizzy > 0) fx.className = 'dizzy';
            else if(state.lightningTimer > 0) fx.className = 'flash';
            else fx.className = '';

            ctx.restore();
        }
    </script>
</body>
</html>